# Docker-command

# Установка Docker в Ubuntu-18.04

Docker-контейнеры в Ubuntu-18.04 — в первую очередь необходимо установить сам Docker.
Чтобы установить последнюю версию Docker и иметь возможность без проблем обновлять ее в будущем — рекомендуется устанавливать Docker из официального репозитория.

Добавьте официальный GPG-ключ Docker-а:

`$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`

Проверьте `fingerprint` ключа и убедитесь, что он следующий — `9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88`:

`$ sudo apt-key fingerprint 0EBFCD88 2>/dev/null | grep 9DC8`

Настройте стабильный Docker-репозиторий:

`$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"`

Установите Docker:

`$ sudo apt-get update`

`$ sudo apt-get install docker-ce`

Запустите Docker:

`$ sudo systemctl start docker`

Убедитесь, что Docker установлен правильно, запустив образ `hello-world`:

`$ sudo docker run hello-world`

необходимо настроить автоматический запуск Docker-демона при загрузке системы.

`$ sudo systemctl enable docker`

чтобы при каждом вызове команды `docker` не набирать `sudo`, добавьте своего пользователя в группу `docker`:

`$ sudo usermod -aG docker $ПОЛЬЗОВАТЕЛЬ`

Чтобы убедиться, что вы можете запускать `docker` без `sudo`, выполните:

`$ docker run hello-world`

# Запуск Контейнера из Образа

Команда `docker run` служит для запуска Docker-контейнеров из образов.


## Образ vs Контейнер Слои — Что Есть Что? — Основное Различие

### ***Что Такое Образ в Docker

В Docker-мире существуют такие понятия, как образы, контейнеры и слои.
Несмотря на то, что они тесно связаны — они отличаются.
Сам по себе Docker-образ невозможно «запускать». Команда docker run берет Docker-образ в качестве темплейта и создает из него контейнер, который и запускается.
Образы создаются из `Dockerfile` с помощью команды `docker build`.
Образы хранятся в `Docker-реестрах`, как например `Docker Hub` и их можно скачать с помощью команды `docker pull`:

`$ docker pull ubuntu`

### ***Что Такое Слои в Docker

Образы в Docker так устроены, что они состоят из нескольких слоев.
Каждая инструкция из `Dockerfile` создает новый слой образа.
Каждый слой представляет собой набор отличий `(diff)` от предыдущего слоя.
Чтобы просмотреть все слоя образа, выполните команду `docker history`:

`$ docker history IMAGE ID`

Каждый слой Docker-образа доступен только для чтение `(read-only)`.

### ***Что Такое Docker-контейнер

# Основное различие между образом и контейнером — в доступном для записи верхнем слое.

Контейнеры создаются из образов с помощью команды `docker run`, а выполнив команду `docker ps` можно узнать какие контейнеры в данный момент запущены

`$ docker run -it ubuntu /bin/bash`

Чтобы создать контейнер, движок Docker берет образ, добавляет доступный для записи верхний слой и инициализирует различные параметры (сетевые порты, имя контейнера, идентификатор и лимиты ресурсов). Все операции на запись внутри контейнера сохраняются в этом верхнем слое и когда контейнер удаляется, верхний слой, который был доступен для записи, также удаляется, в то время как нижние слоя остаются неизменными.

Поскольку каждый контейнер имеет свой собственный слой для записи, и все изменения сохраняются в этом слое, несколько контейнеров могут совместно использовать доступ к одному и тому же основному образу оставаясь каждый в своем собственном состоянии.

# Docker: добавить свой образ в репозиторий на Docker Hub

Пример сборки и отправки в Docker Hub образа с `UserNameDockerHub/ImageName`.

*Собираем 

`$ sudo docker build -t UserNameDockerHub/ImageName .`

*Проверяем его наличие:

`$ sudo docker images | grep ImageName`

*Логинимся в Docker Hub:

```
$ sudo docker login
Username: UsurNameDockerHub
Password: *****
Email: ****
Login Succeeded
```

*Можно поискать аналогичные образы:

`$ sudo docker search ImageName`

*И добавить свой:

`$ sudo docker push UserNameDockerHub/ImageName`

*Если после Ctrl+C будет ошибка вида:

```
FATA[0000] Error response from daemon: push setevoy/azure-cli is already in progress
```

*Перезапустите Docker (правда потом вероятна ошибка «Image already exists«):

`$ sudo service docker restart`

*Проверяем:

`$ sudo docker search ImageName | grep UserNameDockerHub`

*Запускаем

`$ sudo docker run -ti UserNameDockerHub/ImageName`

Для непрерывного запуска контейнера (в фоновом режиме) и доступа к контейнерам, открываемым службами (портами) с хоста или другого удаленного компьютера в вашей локальной сети, выполните приведенную ниже команду в командной строке хоста:

`# docker run -d -p 81:80 ImageName`

Здесь опция -d запускает контейнер в фоновом режиме (как демон), а параметр -p сопоставляет порт контейнера 80 с вашим портом-узлом 81. Доступ к локальной сети через Apache возможен только через порт 81.

Чтобы получить доступ внутрь процессов, запущенных в контейнере, выполните следующую команду:

```
# docker ps
# docker top <name or ID of the container>
```


## Список Docker-образов

Список всех локальных Docker-образов:

`$ docker images`

## Удалить Docker-образ

Удалить Docker-образ по `IMAGE ID`:

`$ docker rmi <image>`

Принудительно удалить Docker-образ:

`$ docker rmi -f <image>`

## Удалить Неиспользуемые Docker-образы

Удалить все неиспользуемые Docker-образы:

`$ docker image prune -a -f`

## Удалить Все Docker-образы

Принудительно удалить все Docker-образы:

`$ docker rmi -f $(docker images -q)`

Если вы получили сообщение о том, что не возможно удалить Docker-образ потому, что он используется запущенным контейнером или от него зависят дочерние образы — попробуйте сначала удалить Docker-контейнеры


## Список Docker-контейнеров

Список запущенных Docker-контейнеров:

`$ docker ps`

Список всех Docker-контейнеров:

`$ docker ps -a`

## Удалить Docker-контейнер

Удалить Docker-контейнер по `CONTAINER ID` или `NAME`:

`$ docker rm <container>`

Принудительно удалить запущенный Docker-контейнер:

`$ docker rm -f <container>`

## Удалить Все Docker-контейнеры

Удалить все остановленные (неиспользуемые) Docker-контейнеры:

`$ docker container prune -f`

Принудительно удалить все Docker-контейнеры, включая запущенные контейнеры:

`$ docker rm -f $(docker ps -a -q)`

Чтобы удалить конкретный Docker-образ в первую очередь необходимо узнать его IMAGE ID сделав листинг всех Docker-образов.
Когда образ для удаления определен он может быть удален с помощью команды docker rmi.
Также из командной строки можно удалить только неиспользуемые Docker-образы (неиспользуемые ни одним из контейнеров) или, если необходимо, вы можете принудительно удалить все загруженные и сохраненные локально Docker-образы

```
docker rm -f $(docker ps -a -q)
docker rmi -f $(docker images -q)
docker build -t sirrax/alpine-nginx /root/docker/  
docker run -d -p 81:80 sirrax/alpine-nginx 
```